##INITIAL SETUP

```{r}
#importing libraries and setting seed
library(rpart)
library(e1071)
library(ggplot2)
library(patchwork)
library(knitr)
library(gt)
library(dplyr)   #R package for data wrangling
library(scales)
library(rpart.plot)
library(caret)
library(pROC)

set.seed(1357)
```

```{r}
#importing dataset

raw_data <- read.csv("C:/Users/Ayush/Documents/NBA/NBA_PLAYERS.csv")

df1 <- raw_data

#Organization
df1$Active[df1$Active=='True'] = 1
df1$Active[df1$Active=='False'] = 0

df1$HOF[df1$HOF=='True']=1
df1$HOF[df1$HOF=='False']=0

df1$Active <- as.factor(df1$Active)
df1$HOF <- as.factor(df1$HOF)

#OUTPUT
head(df1, 10)
tail(df1, 10)
```

##DATA CLEANING

```{r}
#Getting rid of missing HOF value
df2 <- df1[is.na(df1$WS)==FALSE,]

nrow(df1)
nrow(df2)

df1 <- df2


#Making School colunn binary
df1$School[df1$School == ""] = 0
df1$School[df1$School != "0"] = 1

df1$School <- as.factor(df1$School)
```


```{r}
#Getting all of the observations with at least 1 missing value
df_missing_values <- 
  df1 %>% filter(if_any(everything(), is.na))

head(df_missing_values, 30)

#Shows amount of missings in each column
colSums(is.na(df1))

#Finding which era's players have the most missing values (Older players)
ggplot(data = df_missing_values, aes(x = Final)) +
  geom_density() +
  labs(title = "Final year of Players w/ Missing Stats",
       x = "Final Year",
       y = "Density") +
  theme_bw()
```

```{r}
#Find out how to deal with PER, FT., and TRB
PER_MV <- df_missing_values[is.na(df_missing_values$PER),]
FT_MV <- df_missing_values[is.na(df_missing_values$FT.),]
TRB_MV <- df_missing_values[is.na(df_missing_values$TRB),]

ggplot(data = PER_MV, aes(x = Final)) +
  geom_density() +
  labs(title = "Final year of Players w/ Missing PER Stat",
       x = "Final Year",
       y = "Density") +
  theme_bw()

ggplot(data = FT_MV, aes(x = Final)) +
  geom_density() +
  labs(title = "Final year of Players w/ Missing FT% Stat",
       x = "Final Year",
       y = "Density") +
  theme_bw()

ggplot(data = TRB_MV, aes(x = Final)) +
  geom_density() +
  labs(title = "Final year of Players w/ Missing TRB Stat",
       x = "Final Year",
       y = "Density") +
  theme_bw()


PER_MV <-
  PER_MV %>% arrange(Final)

tail(PER_MV, 20)

#Everyone with a final year under 1952 has a missing PER
nrow(PER_MV) - 3
nrow(df1[df1$Final <= 1951,])
```



```{r}
#Archiving the data
full_data <- df1

#Fully getting rid of these columns,  they won't have much effect on Hall of Fame status
df1 <- full_data %>% select(-FG3., -FT., -eFG.)

#Get rid of players who retired in 1951 and older
df1[df1$Final <= 1951 & as.numeric(as.character(df1$HOF)) == 1,]

df2 <- df1[df1$Final > 1951,]

nrow(df1)
nrow(df2)
```

```{r}
#Check the newly cleaned dataframe
nrow(df2)
colSums(is.na(df2))

FG_MV <- df2 %>% filter(is.na(FG.))

#Players with 3 games or under often have missing stats. Let's remove players with 5 games or under
finished_data <- df2 %>% filter(G > 5)

nrow(finished_data)

colSums(is.na(finished_data))


#Finalizing the data cleaning
df2 <- finished_data

nrow(df2)

colSums(is.na(finished_data))

```

## INTIIAL DATA VISUALIZATION

```{r}
df3 <- finished_data

t1 <- table(df3$Active)
t2 <- table(df3$HOF)
t3 <- table(df3$HOF)/nrow(df3)
t4 <- table(df3$Active)/nrow(df3)

t1 <- as.data.frame(t1)
t2 <- as.data.frame(t2)
t3 <- as.data.frame(t3)
t4 <- as.data.frame(t4)

gt(t1) %>%
  tab_header(title = "Active vs. Retired Players")
gt(t4) %>%
  tab_header(title = "Active vs. Retired Proportion Table")
gt(t2) %>%
  tab_header(title = "HOF Players")
gt(t3) %>%
  tab_header(title = "HOF Players Proportion")


#Looking at durations of players' careers
ggplot(data = df3, aes(x=Final-Debut)) +
  geom_histogram(bins=21, binwidth=1) +
  labs(title = "Career Durations",
       x="Duration",
       y="Number of Players")

#table showing top 20 players Duration-wise
df3$Duration <- df3$Final - df3$Debut + 1
df3[order(-(df3$Duration)),] %>% select(Name, Duration, Debut, Final, HOF) %>% head(30)

#Looking at Height distribution
ggplot(data = df3, aes(x = Height/12)) +
  geom_histogram(binwidth=1/12) +
  labs(title="Height Distribution in NBA",
       x = "Height"
  ) +
  theme_classic()

df3[order(df3$Height),] %>% select(Name, Height=Height/12, Duration, HOF) %>% head(30)

#Looking at Weight distribution
ggplot(df3, aes(x = Weight)) +
  geom_histogram(binwidth=5) +
  labs(title = "Weight Distribution in NBA",
       x = "Weight"
       )

#Comparing Height vs. Weight
df3_hw <- df3[is.na(df2$Height)==FALSE & is.na(df2$Weight)==FALSE,]

ggplot(df3_hw, aes(x=Height + runif(nrow(df3_hw), -0.1, 0.1), y=Weight)) +
  geom_point(alpha=.3) +
  geom_smooth(method="lm", se = FALSE, color = "red")
  labs(title = "Height and Weight",
       x = "Height",
       y= "Weight"
       ) +
  scale_x_continuous(labels = scales::label_number())

ggplot(df3_hw, aes(x=Height + runif(nrow(df3_hw), -0.1, 0.1), y=Weight)) +
  geom_bin_2d(bins=25) +
  labs(title = "Height and Weight",
       x = "Height",
       y= "Weight"
       ) +
  scale_x_continuous(labels = scales::label_number()) +
  geom_smooth(method="lm", se = FALSE, color = "red")

ggplot(df3_hw, aes(x=Height + runif(nrow(df3_hw), -0.1, 0.1), y=Weight)) +
  geom_density_2d() +
  labs(title = "Height and Weight",
       x = "Height",
       y= "Weight"
       ) +
  scale_x_continuous(labels = scales::label_number())


  

```

```{r}
df3_one_pos <- df3[grepl(",", df3$Position)==FALSE,]
hof_df <- df3_one_pos %>% filter(HOF==1)  #filter for only HOF inductees


# Define breaks and labels
valid_years <- hof_df$Final[is.finite(hof_df$Final)]
breaks <- seq(1950, max(valid_years)+10 , by = 25)
labels <- paste0(breaks[-length(breaks)], "â€“", breaks[-1] - 1)

# Create era bins
hof_df <- hof_df %>% 
  mutate(Era = cut(Final,
                   breaks = breaks,
                   labels = labels,
                   right = FALSE,
                   include.lowest = TRUE))

# Group and count by Era and Position
hof_summary <- hof_df %>%
  group_by(Era, Position) %>%
  summarise(Count = n(), .groups = "drop")

# Plot proportions
ggplot(hof_summary, aes(x = Era, y = Count, fill = Position)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_y_continuous(labels = percent) +
  labs(title = "HOF Inductions over the Years by Position",
       x = "Final Year Era",
       y = "Proportion of HOF Inductees",
       fill = "Position") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))
```

```{r}
#Looking at Player winshares
theme_custom <- theme(

  text = element_text(size = 12),

  panel.grid = element_blank(),

  panel.grid.major.y = element_line(colour = "#e3e1e1",

  linetype = 2),

  plot.title.position = 'plot',

  legend.position = 'top',

  legend.title = element_blank()

  )


ggplot(data = df3, aes(x=WS)) +
  geom_density() +
  labs(title = "Player Winshare Probability",
       x = "Winshares",
  ) +
  scale_y_continuous(labels = label_number())

ggplot(data = df3, aes(x=PTS)) +
  geom_density() +
  labs(title = "Player Points Probability",
       x = "Points",
  ) +
  scale_y_continuous(labels = label_number()) +
  theme_set(theme_minimal() + theme_custom)

df3$HOF <- as.numeric(as.character(df3$HOF))
ggplot(data = df3, aes(x=WS, y=HOF)) +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = TRUE) +
  labs(title = "HOF based on Winshares",
       x = "Winshares",
       y = "HOF Chance") +
  theme_set(theme_minimal() + theme_custom)

ggplot(data = df3, aes(x=PTS, y=HOF)) +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = TRUE) +
  labs(title = "HOF based on Points",
       x = "Points",
       y = "HOF Chance") +
  theme_bw()

df3$HOF <- as.factor(df3$HOF)

#table showing top 20 players Winshare-wise
df3[order(-df3$WS),] %>% select(Name,WS,HOF,Active, Final) %>% head(80) 

#table showing top 20 players Points-wise: More skewed towards modern players
df3[order(-df3$PTS),] %>% select(Name,PTS,HOF,Active, Final) %>% head(80) 


```




```{r}
#TRY ASSISTS

df3$HOF <- as.numeric(as.character(df3$HOF))

ggplot(data = df3, aes(x=AST, y=HOF)) +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = TRUE) +
  labs(title = "HOF based on Assists",
       x = "Points",
       y = "HOF Chance") +
  theme_bw()

df3$HOF <- as.factor((df3$HOF))



ggplot(data = df3_one_pos, aes(x = AST, group=Position, fill=Position)) +
  geom_density(alpha = .5) +
  labs(title = "Assists based on Position",
       x = "Assists",
       y = "Density")
  
```

```{r}
#TRY GAMES
df3$HOF <- as.numeric(as.character(df3$HOF))

ggplot(data = df3, aes(x=G, y=HOF)) +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = TRUE) +
  labs(title = "HOF based on Games Played",
       x = "Games",
       y = "HOF Chance") +
  theme_bw()

df3$HOF <- as.factor((df3$HOF))
```

```{r}
#TRY PER
df3$HOF <- as.numeric(as.character(df3$HOF))

ggplot(data = df3, aes(x=PER, y=HOF)) +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = TRUE) +
  labs(title = "HOF based on PER",
       x = "PER",
       y = "HOF Chance") +
  theme_bw()

df3$HOF <- as.factor((df3$HOF))

ggplot(data = df3_one_pos, aes(x = PER, group=Position, fill=Position)) +
  geom_density(alpha = .5) +
  labs(title = "PER based on Position",
       x = "PER",
       y = "Density")

```

```{r}
#Try Height and Weight, and Height-to-Weight Ratio
df3$HOF <- as.numeric(as.character(df3$HOF))

#Height
ggplot(data = df3, aes(x=Height, y=HOF)) +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = TRUE) +
  labs(title = "HOF based on Height",
       x = "Height",
       y = "HOF Chance") +
  theme_bw()

#Weight
ggplot(data = df3, aes(x=Weight, y=HOF)) +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = TRUE) +
  labs(title = "HOF based on Weight",
       x = "Weight",
       y = "HOF Chance") +
  theme_bw()


#Height-Weight Ratio
ggplot(data = df3, aes(x=Height/Weight, y=HOF)) +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = TRUE) +
  labs(title = "HOF based on Height-Weight Ratio",
       x = "Height-Weight Ratio",
       y = "HOF Chance") +
  theme_bw()

df3$HOF <- as.factor(as.character(df3$HOF))
```




#MODELS - RPART

```{r}
#Making the training and testing datasets  --> first we want to test which model is the most accurate
df4 <- 
  df3 %>% 
  filter(Final < 2021) %>% 
  arrange(Name) %>%
  select(-Birthday, -Active, -School, -Position, -Duration, -Height, -Weight)
  
training <- df4 %>% select(-Name, -Final) %>% slice(1:floor(nrow(df4)*.8))
testing <- df4 %>% select(-Name, -Final) %>% slice(ceiling(nrow(df4)*.82):nrow(df4))
1
cat("Total Observations: ", nrow(df4), "\n")
cat("Total training data Observations: ", nrow(training), "\n")
cat("Total testing data Observations: ", nrow(testing), "\n")
cat("Split: ", (1-nrow(testing)/nrow(training)), "/", nrow(testing)/nrow(training), "\n")
cat("HOF's in Training data", nrow(training[training$HOF == 1,]), "\n",
    "HOF's in Testing data", nrow(testing[testing$HOF == 1,]), "\n")

HOF_prop <- 32/143

cat ("   Split: ", 1-HOF_prop, "/", HOF_prop)

testing_class_split <- nrow(testing[])

cat("")
```
```{r}
colnames(df4)
print("")
colnames(training)
```


```{r}
#caret control with resampling

training$HOF <- factor(training$HOF, levels = c(0, 1), labels = c("NotHOF", "HOF"))
testing$HOF  <- factor(testing$HOF,  levels = c(0, 1), labels = c("NotHOF", "HOF"))

ctrl <- trainControl(method = "repeatedcv",     # cross-validation
                     number = 5,                 # 5-fold CV
                     repeats = 3,                # repeat 3 times
                     sampling = "smote",            # try "down" or "smote"
                     classProbs = TRUE,          # needed for ROC
                     summaryFunction = twoClassSummary)  # evaluates by ROC

tree_model <- train(HOF ~ ., 
                    data = training,
                    method = "rpart",
                    trControl = ctrl,
                    metric = "ROC",
                    tuneLength = 10)

print(tree_model)
plot(tree_model)
```

```{r}
# Predict classes
tree_preds <- predict(tree_model, newdata = testing)

# Predict probabilities for ROC
tree_probs <- predict(tree_model, newdata = testing, type = "prob")[, "HOF"]



```


```{r}
#RPART EVALUATION

#ROC CURVE
library(pROC)
roc_obj <- roc(testing$HOF, tree_probs, levels = c("NotHOF", "HOF"))
plot(roc_obj)
auc(roc_obj)

#CONFUSION MATRIX
conf_mat <- confusionMatrix(tree_preds, testing$HOF, positive = "HOF")
print(conf_mat)

#Key Metrics
precision <- conf_mat$byClass["Precision"]
recall <- conf_mat$byClass["Recall"]
f1 <- conf_mat$byClass["F1"]
cat("\nPrecision (How many predicted HOFs were correct?):", round(precision, 3),
    "\nRecall (How many actual HOFs were correctly found?):", round(recall, 3),
    "\nF1 Score (Balance of precision and recall):", round(f1, 3))



```

```{r}
#PR CURVE AND PR AUC
library(PRROC)

#Final summary
cat("----- Model Evaluation (Imbalanced Classes) -----\n")
cat("Precision: ", round(precision, 3), "     (How many predicted HOFs were correct?)", "\n")
cat("Recall:    ", round(recall, 3), "     (How many actual HOFs were correctly found?) \n")
cat("F1 Score   ", round(f1, 3),     "     (Balance of precision and recall) \n\n")
cat("Baseline accuracy: ", mean(testing$HOF == "HOF"), "\n\n")
cat("ROC AUC: ", round(auc(roc_obj), 3), " (Overall discriminative ability - prone to imbalance) \n")
cat("PR AUC:  ", round(pr$auc.integral, 3), "  (Precision-Recall tradeoff - great for imbalance, compare to baseline accuracy)\n")

# Create scores for PR AUC
fg <- tree_probs[testing$HOF == "HOF"]
bg <- tree_probs[testing$HOF == "NotHOF"]

pr <- pr.curve(scores.class0 = fg, scores.class1 = bg, curve = TRUE)
plot(pr, main = "Precision-Recall Curve")

```


#MODELS - XGBOOST: Gradient Boosted Trees


